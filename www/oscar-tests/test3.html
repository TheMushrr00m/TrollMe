<!doctype html> 
<html lang="en"> 
<head> 
	<meta charset="UTF-8" />
    <title>TrollMe Mode On!</title>
    <script type="text/javascript" src="oscar-tests/js/phaser.min.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
        #location {
            display: none;
        }
    }
    </style>
</head>
<body>
<p id="location" display="none">1</p>

<script src="oscar-tests/html_updater.js"></script>

<script type="text/javascript">

    var locationDiv = document.getElementById('location')

    var magicWidthNumber = 0.60
    var magicHeightNumber = 0.80
    
    if( /Internet Explorer|Firefox/i.test(navigator.userAgent) ) 
    {
        window.devicePixelRatio = 1;
    }

    var width = window.screen.availWidth * window.devicePixelRatio * magicWidthNumber;
    var height = window.screen.availHeight * window.devicePixelRatio * magicHeightNumber;

    //var availWidth = window.screen.availWidth * magicWidthNumber;
    //var availHeight = window.screen.availHeight * magicHeightNumber;


    const MAP_WIDTH = 2724;
    const MAP_HEIGHT = 1875;

    //var lGameScale;

    var game = new Phaser.Game(width, height, Phaser.CANVAS, 'trollme', { preload: preload, create: create, update: update}); //800, 600

    function preload() {
        window.addEventListener('resize', function() {
            resize();
        });
        //game.scale.scaleMode = Phaser.ScaleManager.RESIZE;
        game.scale.minWidth = width/2;
        game.scale.minHeight = height/2;
        game.scale.maxWidth = width;
        game.scale.maxHeight = height;
    	game.stage.backgroundColor = '#999999';

        // Load the image and create it into an array of images, 32px width 48 pix height
        game.load.spritesheet('dude', 'oscar-tests/assets/sprites/dude2.png', 32, 40);
        game.load.image('parque', 'oscar-tests/assets/buildings/parque.png');
        game.load.image('casa', 'oscar-tests/assets/buildings/casa.png');
        game.load.image('casa2', 'oscar-tests/assets/buildings/casa2.png');
        game.load.image('mall', 'oscar-tests/assets/buildings/mall.png');
        game.load.image('tienda', 'oscar-tests/assets/buildings/tienda.png');
        game.load.image('tienda2', 'oscar-tests/assets/buildings/tienda2.png');
        game.load.image('edificioFrente', 'oscar-tests/assets/buildings/edificioFrente.png');
        game.load.image('edificioLateral', 'oscar-tests/assets/buildings/edificioLateral.png');
        game.load.physics('sprite_physics', 'oscar-tests/assets/physics/sprite_physics.json');
    }

    var player;
    var cursors;
    var t;
    var shop2;

    var tile;
    //var group_all;

    function create() {
        game.world.setBounds(0, 0, MAP_WIDTH, MAP_HEIGHT);
        game.physics.startSystem(Phaser.Physics.P2JS);
        game.physics.p2.gravity.y = 0;

        game.add.sprite(248, 637, 'parque');

        // Set The Bounds of the world where the camera can move to

        player = game.add.sprite(game.world.centerX, game.world.centerY, 'dude');
        game.physics.p2.enable(player);

        player.body.fixedRotation = true;
        player.body.clearShapes();
        player.body.loadPolygon('sprite_physics', 'lil_dude');

        buildings = game.add.group();
        //group_all = game.add.group();

        player.animations.add('left', [0, 1, 2, 3], 10, true);
        player.animations.add('right', [6, 7, 8, 9], 10, true);

        /*
    	game.add.text(0, 0, "this text scrolls\nwith the background", { font: "32px Arial", fill: "#f26c4f", align: "center" });

    	this.t = game.add.text(0, 0, "this text is fixed to the camera", { font: "32px Arial", fill: "#ffffff", align: "center" });
        // Fix the text t to the camera
        this.t.fixedToCamera = true;
        // Put an offset to the text
        this.t.cameraOffset.setTo(200, 500);
        */

        house2 = buildings.create(1059 + game.cache.getImage('casa2').width / 2, 322 + game.cache.getImage('casa2').height / 2, 'casa2');
        enableP2Physics(house2);

        var house2 = buildings.create(827 + game.cache.getImage('casa2').width / 2, 438 + game.cache.getImage('casa2').height / 2, 'casa2');
        enableP2Physics(house2);

        var house = buildings.create(639 + game.cache.getImage('casa').width / 2, 609 + game.cache.getImage('casa').height / 2, 'casa');
        enableP2Physics(house);
        
        var shop = buildings.create(530 + game.cache.getImage('tienda').width / 2, 708 + game.cache.getImage('tienda').height / 2, 'tienda');
        enableP2Physics(shop);

        var shop2 = buildings.create(400 + game.cache.getImage('tienda2').width / 2, 826 + game.cache.getImage('tienda2').height / 2, 'tienda2');
        enableP2Physics(shop2);

        var buildingFront = buildings.create(0 + game.cache.getImage('edificioFrente').width / 2, 570 + game.cache.getImage('edificioFrente').height / 2, 'edificioFrente');
        enableP2Physics(buildingFront);

        var buildingLateral = buildings.create(1399 + game.cache.getImage('edificioLateral').width / 2, 0 + game.cache.getImage('edificioLateral').height / 2, 'edificioLateral');
        enableP2Physics(buildingLateral);
        
        buildingLateral = buildings.create(1602 + game.cache.getImage('edificioLateral').width / 2, 117 + game.cache.getImage('edificioLateral').height / 2, 'edificioLateral');
        enableP2Physics(buildingLateral);
        
        buildingLateral = buildings.create(1805 + game.cache.getImage('edificioLateral').width / 2, 227 + game.cache.getImage('edificioLateral').height / 2, 'edificioLateral');
        enableP2Physics(buildingLateral);

        var mall = buildings.create(2007 + game.cache.getImage('mall').width / 2, 572 + game.cache.getImage('mall').height / 2, 'mall');
        enableP2Physics(mall);

        game.camera.follow(player);

        player.body.createBodyCallback(house, changeLocation, this);

        game.physics.p2.setImpactEvents(true);
        
        //group_all.add(player);
        //group_all.add(buildings);

        cursors = game.input.keyboard.createCursorKeys();
        resize();
    }

    function update() {
        //console.log(locationDiv.innerHTML);
        var moving = false;
        //player.body.velocity.x = 0;
        //player.body.velocity.y = 0;

        if (game.input.mousePointer.isDown) 	
        {
            //  400 is the speed it will move towards the mouse
            game.physics.arcade.moveToPointer(player, 400);
            if (Math.abs(player.body.velocity.x) > Math.abs(player.body.velocity.y))
            {
            	if (player.body.velocity.x > 0 )
            	{
            		player.animations.play('right');
            	}
            	else
            	{
            		player.animations.play('left');
            	}
            }
            else
            {
            	if (player.body.velocity.y > 0 )
            	{
            		player.frame = 4;
            	}
            	else
            	{
            		player.frame = 5;
            	}
            }

            //  if it's overlapping the mouse, don't move any more
            if (Phaser.Rectangle.contains(player.body, game.input.x, game.input.y))
            {
                player.body.velocity.x = 0;
                player.body.velocity.y = 0;

                //  Stand still
            	player.animations.stop();

            	player.frame = 4;
            }
        }
        else
        {
            if (cursors.up.isDown)
            {
                player.frame = 5;
                player.body.moveUp(400);
                moving = true;
            }
            else if (cursors.down.isDown)
            {
                player.frame = 4;
                player.body.moveDown(400);
                moving = true;
            }
            else
            {
                player.body.velocity.y = 0;
            }
            if (cursors.left.isDown)
            {
                player.body.moveLeft(400);
                player.animations.play('left');
                moving = true;
            }
            else if (cursors.right.isDown)
            {
                player.animations.play('right');
                player.body.moveRight(400);
                moving = true;
            }
            else
            {
                player.body.velocity.x = 0;
            }
            if(!moving)
            {
                player.body.velocity.x = 0;
                player.body.velocity.y = 0;
                //  Stand still
                player.animations.stop();
                player.frame = 4;
            }
                
        }

        //group_all.sort('y', Phaser.Group.SORT_ASCENDING);
    }

    function enableP2Physics(object1)
    {
        game.physics.p2.enable(object1, false);
        object1.body.offset.setTo();
        object1.body.static = true;
        object1.body.fixedRotation = true;
        object1.body.clearShapes();
        object1.body.loadPolygon('sprite_physics', object1.key);
    }

    function changeLocation()
    {
        locationDiv.innerHTML = 2;
    }

    function resize()
    {
        //lGameScale = Math.round(10000 * Math.min(game.width / SAFE_ZONE_WIDTH,game.height / SAFE_ZONE_HEIGHT)) / 10000;
        //width = window.innerWidth * window.devicePixelRatio;
        //height = window.innerHeight * window.devicePixelRatio;
        
        //game.width = width;
        //game.height = height;

        //game.scale.setGameSize(width * magicWidthNumber, height * magicHeightNumber);

        //game.renderer.resize(width * magicWidthNumber, height * magicHeightNumber);
        

        //game.stage.setTo (lGameScale,lGameScale);
        //world.x=(game.width-SAFE_ZONE_WIDTH*lGameScale)/2;
        //world.y=(game.height-SAFE_ZONE_HEIGHT*lGameScale)/2;
        //game.camera.setSize(width, height);

        game.scale.scaleMode = Phaser.ScaleManager.SHOW_ALL;
    }

</script>
</body>
</html>